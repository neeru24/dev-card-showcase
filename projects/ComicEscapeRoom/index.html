<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comic Escape Room</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --comic-red: #e63946;
            --comic-blue: #457b9d;
            --comic-yellow: #ffd166;
            --comic-green: #06d6a0;
            --comic-purple: #8338ec;
            --panel-bg: #f8f9fa;
            --panel-border: #212529;
        }

        body {
            font-family: 'Comic Neue', cursive;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .comic-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .comic-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .title {
            font-family: 'Bangers', cursive;
            font-size: 4.5rem;
            color: white;
            text-shadow: 
                5px 5px 0 var(--comic-red),
                10px 10px 0 rgba(0, 0, 0, 0.3);
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.5rem;
            color: var(--comic-yellow);
            font-weight: 700;
            margin-bottom: 20px;
        }

        /* Comic Page */
        .comic-page {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border: 8px solid var(--panel-border);
            position: relative;
            min-height: 600px;
            margin-bottom: 40px;
        }

        .comic-page:before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 3px solid var(--comic-red);
            border-radius: 8px;
            pointer-events: none;
        }

        /* Panels Grid */
        .panels-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 40px;
        }

        @media (max-width: 1024px) {
            .panels-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .panels-container {
                grid-template-columns: 1fr;
            }
        }

        /* Panel Styling */
        .panel {
            background-color: var(--panel-bg);
            border: 4px solid var(--panel-border);
            border-radius: 10px;
            padding: 20px;
            position: relative;
            min-height: 350px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .panel.active {
            border-color: var(--comic-green);
            box-shadow: 0 0 0 3px var(--comic-green);
        }

        .panel.locked {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .panel.locked:hover {
            transform: none;
            box-shadow: none;
        }

        .panel-number {
            position: absolute;
            top: -15px;
            left: -15px;
            background-color: var(--comic-red);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bangers', cursive;
            font-size: 1.5rem;
            border: 3px solid var(--panel-border);
            z-index: 2;
        }

        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-family: 'Bangers', cursive;
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--comic-blue);
            text-align: center;
        }

        .panel-image {
            height: 150px;
            background-color: #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid var(--panel-border);
        }

        .panel-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .panel-description {
            font-size: 1rem;
            line-height: 1.4;
            margin-bottom: 15px;
            flex: 1;
        }

        .panel-status {
            text-align: center;
            font-weight: 700;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .panel-status.solved {
            background-color: rgba(6, 214, 160, 0.2);
            color: var(--comic-green);
        }

        .panel-status.unsolved {
            background-color: rgba(230, 57, 70, 0.2);
            color: var(--comic-red);
        }

        /* Puzzle Display */
        .puzzle-display {
            background-color: white;
            border: 4px solid var(--panel-border);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            min-height: 400px;
            display: none;
        }

        .puzzle-display.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .puzzle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 3px solid var(--comic-red);
            padding-bottom: 15px;
        }

        .puzzle-title {
            font-family: 'Bangers', cursive;
            font-size: 2.5rem;
            color: var(--comic-blue);
        }

        .puzzle-close {
            background-color: var(--comic-red);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .puzzle-close:hover {
            transform: scale(1.1);
        }

        .puzzle-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .puzzle-scene {
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .puzzle-visual {
            flex: 1;
            min-width: 300px;
            background-color: #f0f0f0;
            border-radius: 10px;
            padding: 20px;
            border: 3px solid var(--panel-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 250px;
        }

        .puzzle-interaction {
            flex: 1;
            min-width: 300px;
        }

        .puzzle-instructions {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--comic-blue);
            font-weight: 700;
        }

        .puzzle-input {
            width: 100%;
            padding: 15px;
            border: 3px solid var(--panel-border);
            border-radius: 8px;
            font-size: 1.2rem;
            font-family: 'Comic Neue', cursive;
            margin-bottom: 20px;
        }

        .puzzle-input:focus {
            outline: none;
            border-color: var(--comic-green);
        }

        .puzzle-buttons {
            display: flex;
            gap: 15px;
        }

        .comic-button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-family: 'Comic Neue', cursive;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            border: 3px solid var(--panel-border);
        }

        .comic-button.primary {
            background-color: var(--comic-green);
            color: white;
        }

        .comic-button.secondary {
            background-color: var(--comic-blue);
            color: white;
        }

        .comic-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .comic-button:active {
            transform: translateY(0);
        }

        /* Speech Bubbles */
        .speech-bubble {
            position: relative;
            background-color: white;
            border: 3px solid var(--panel-border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            max-width: 80%;
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 30px;
            border-width: 15px 15px 0;
            border-style: solid;
            border-color: white transparent;
            display: block;
            width: 0;
        }

        .speech-bubble:before {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 27px;
            border-width: 18px 18px 0;
            border-style: solid;
            border-color: var(--panel-border) transparent;
            display: block;
            width: 0;
        }

        .speech-bubble.right {
            margin-left: auto;
        }

        .speech-bubble.right:after {
            left: auto;
            right: 30px;
        }

        .speech-bubble.right:before {
            left: auto;
            right: 27px;
        }

        /* Hint System */
        .hint-container {
            background-color: rgba(255, 209, 102, 0.2);
            border: 2px dashed var(--comic-yellow);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .hint-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .hint-title {
            font-weight: 700;
            color: var(--comic-yellow);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Progress Bar */
        .progress-container {
            background-color: white;
            border: 4px solid var(--panel-border);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .progress-title {
            font-family: 'Bangers', cursive;
            font-size: 1.8rem;
            color: var(--comic-blue);
            margin-bottom: 15px;
            text-align: center;
        }

        .progress-bar {
            height: 30px;
            background-color: #f0f0f0;
            border-radius: 15px;
            border: 3px solid var(--panel-border);
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--comic-green), var(--comic-blue));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 12px;
        }

        .progress-text {
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* Sound Effects */
        .sound-effect {
            font-family: 'Bangers', cursive;
            font-size: 2rem;
            color: var(--comic-red);
            text-align: center;
            transform: rotate(-5deg);
            text-shadow: 2px 2px 0 var(--panel-border);
            margin: 15px 0;
            animation: pulse 1s infinite alternate;
        }

        /* Success Screen */
        .success-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .success-screen.active {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        .success-content {
            background-color: white;
            border: 8px solid var(--comic-green);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            text-align: center;
            animation: zoomIn 0.5s ease;
        }

        .success-title {
            font-family: 'Bangers', cursive;
            font-size: 4rem;
            color: var(--comic-green);
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 var(--panel-border);
        }

        .success-message {
            font-size: 1.3rem;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes pulse {
            from { transform: scale(1) rotate(-5deg); }
            to { transform: scale(1.1) rotate(-5deg); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s;
        }

        /* Footer */
        .comic-footer {
            text-align: center;
            color: white;
            padding: 20px;
            font-size: 0.9rem;
        }

        /* Inventory */
        .inventory {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .inventory-item {
            background-color: var(--comic-yellow);
            border: 3px solid var(--panel-border);
            border-radius: 8px;
            padding: 10px 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="comic-wrapper">
        <!-- Header -->
        <header class="comic-header">
            <h1 class="title">COMIC ESCAPE ROOM</h1>
            <p class="subtitle">Solve each panel puzzle to escape the comic book!</p>
            <div class="sound-effect">KAPOW!</div>
        </header>

        <!-- Progress Bar -->
        <div class="progress-container">
            <h2 class="progress-title">ESCAPE PROGRESS</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0/6 Puzzles Solved</div>
        </div>

        <!-- Comic Panels -->
        <div class="comic-page">
            <div class="panels-container" id="panelsContainer">
                <!-- Panels will be added dynamically -->
            </div>
        </div>

        <!-- Puzzle Display Area -->
        <div class="puzzle-display" id="puzzleDisplay">
            <div class="puzzle-header">
                <h2 class="puzzle-title" id="puzzleTitle">Panel Puzzle</h2>
                <button class="puzzle-close" id="puzzleClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="puzzle-content" id="puzzleContent">
                <!-- Puzzle content will be loaded dynamically -->
            </div>
        </div>

        <!-- Success Screen -->
        <div class="success-screen" id="successScreen">
            <div class="success-content">
                <h2 class="success-title">ESCAPE SUCCESSFUL!</h2>
                <div class="sound-effect">BOOM! ZAP! WHAM!</div>
                <p class="success-message">
                    Congratulations! You've solved all the puzzles and escaped the comic book!
                    Your keen mind and problem-solving skills have saved the day. The comic book
                    world is safe once again, thanks to you!
                </p>
                <div class="puzzle-buttons">
                    <button class="comic-button primary" id="restartButton">
                        <i class="fas fa-redo"></i> Play Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="comic-footer">
        <p>Comic Escape Room | Each puzzle is a panel | Made with <i class="fas fa-heart" style="color:#e63946;"></i></p>
    </footer>

    <!-- Sound effects -->
    <audio id="correctSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
    <audio id="wrongSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>
    <audio id="pageSound" src="https://assets.mixkit.co/sfx/preview/mixkit-page-turn-swipe-3003.mp3"></audio>
    <audio id="successSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const panelsContainer = document.getElementById('panelsContainer');
            const puzzleDisplay = document.getElementById('puzzleDisplay');
            const puzzleTitle = document.getElementById('puzzleTitle');
            const puzzleContent = document.getElementById('puzzleContent');
            const puzzleClose = document.getElementById('puzzleClose');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const successScreen = document.getElementById('successScreen');
            const restartButton = document.getElementById('restartButton');
            
            // Audio elements
            const correctSound = document.getElementById('correctSound');
            const wrongSound = document.getElementById('wrongSound');
            const pageSound = document.getElementById('pageSound');
            const successSound = document.getElementById('successSound');
            
            // Game state
            let gameState = {
                currentPanel: null,
                solvedPanels: [],
                inventory: [],
                hintsUsed: 0
            };
            
            // Puzzle data
            const puzzles = [
                {
                    id: 1,
                    title: "The Locked Door",
                    description: "You find yourself in a mysterious room. The door is locked with a strange mechanism. There's a note on the table with a riddle.",
                    status: "unsolved",
                    solution: "2718",
                    type: "riddle",
                    content: {
                        visual: `
                            <div style="text-align: center; width: 100%;">
                                <div style="font-size: 5rem; margin-bottom: 20px;">üîí</div>
                                <div style="font-family: 'Bangers', cursive; font-size: 2rem; color: var(--comic-red); margin-bottom: 10px;">4-DIGIT LOCK</div>
                                <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 20px;">
                                    <div style="width: 50px; height: 70px; background-color: #333; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold;">?</div>
                                    <div style="width: 50px; height: 70px; background-color: #333; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold;">?</div>
                                    <div style="width: 50px; height: 70px; background-color: #333; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold;">?</div>
                                    <div style="width: 50px; height: 70px; background-color: #333; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold;">?</div>
                                </div>
                            </div>
                        `,
                        instructions: "Solve the riddle to find the 4-digit code:<br><br>'I am not a circle, but I never end. I'm found in math, on which you depend. The first four digits of me, to the door you must send.'",
                        hint: "Think about a famous mathematical constant that starts with 2.718..."
                    }
                },
                {
                    id: 2,
                    title: "The Cryptic Message",
                    description: "You discover a torn piece of paper with a strange coded message. It seems to be written in some kind of cipher.",
                    status: "unsolved",
                    solution: "COMIC",
                    type: "cipher",
                    content: {
                        visual: `
                            <div style="text-align: center; width: 100%;">
                                <div style="font-size: 5rem; margin-bottom: 20px;">üìú</div>
                                <div style="background-color: #f0f0f0; padding: 20px; border-radius: 10px; border: 3px solid var(--panel-border); font-family: monospace; font-size: 1.5rem; letter-spacing: 5px;">
                                    DPNJD
                                </div>
                                <div style="margin-top: 20px; font-weight: bold; color: var(--comic-blue);">
                                    Caesar Cipher: Shift = ?
                                </div>
                            </div>
                        `,
                        instructions: "The message 'DPNJD' is encoded using a Caesar cipher. Each letter is shifted by the same amount in the alphabet. What does it say?",
                        hint: "Try shifting each letter backward by 1 position in the alphabet."
                    }
                },
                {
                    id: 3,
                    title: "The Pattern Puzzle",
                    description: "A wall panel has a sequence of symbols. You need to figure out the pattern to continue the sequence.",
                    status: "unsolved",
                    solution: "TRIANGLE",
                    type: "pattern",
                    content: {
                        visual: `
                            <div style="text-align: center; width: 100%;">
                                <div style="font-size: 5rem; margin-bottom: 20px;">üß©</div>
                                <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
                                    <div style="font-size: 3rem;">‚¨ú</div>
                                    <div style="font-size: 3rem;">üî∂</div>
                                    <div style="font-size: 3rem;">‚¨ú</div>
                                    <div style="font-size: 3rem;">üî∂</div>
                                    <div style="font-size: 3rem;">‚¨ú</div>
                                    <div style="font-size: 3rem;">?</div>
                                </div>
                                <div style="font-weight: bold; color: var(--comic-purple);">
                                    Pattern: Square, Triangle, Square, Triangle, Square, ?
                                </div>
                            </div>
                        `,
                        instructions: "Identify the pattern in the sequence and determine what comes next. Enter your answer as a word (e.g., 'TRIANGLE' or 'SQUARE').",
                        hint: "Look at the alternating pattern. What comes after a square in this sequence?"
                    }
                },
                {
                    id: 4,
                    title: "The Hidden Objects",
                    description: "A detailed illustration contains several hidden objects. Find all the items to reveal a clue.",
                    status: "unsolved",
                    solution: "KEY",
                    type: "hidden",
                    content: {
                        visual: `
                            <div style="text-align: center; width: 100%;">
                                <div style="font-size: 5rem; margin-bottom: 20px;">üîç</div>
                                <div style="background-color: #e0e0e0; padding: 20px; border-radius: 10px; border: 3px solid var(--panel-border); position: relative; min-height: 200px;">
                                    <div style="position: absolute; top: 30px; left: 40px; font-size: 2rem;">üóùÔ∏è</div>
                                    <div style="position: absolute; top: 80px; right: 60px; font-size: 2rem;">üìñ</div>
                                    <div style="position: absolute; bottom: 50px; left: 100px; font-size: 2rem;">üïØÔ∏è</div>
                                    <div style="position: absolute; bottom: 30px; right: 100px; font-size: 2rem;">‚úèÔ∏è</div>
                                </div>
                                <div style="margin-top: 20px; font-weight: bold; color: var(--comic-green);">
                                    Find the hidden objects! One of them is the answer.
                                </div>
                            </div>
                        `,
                        instructions: "Look at the scene above. One of the hidden objects is the answer to this puzzle. Which object might unlock something?",
                        hint: "Think about what you would use to unlock a door."
                    }
                },
                {
                    id: 5,
                    title: "The Math Challenge",
                    description: "A strange device displays a mathematical equation. Solve it to proceed.",
                    status: "unsolved",
                    solution: "42",
                    type: "math",
                    content: {
                        visual: `
                            <div style="text-align: center; width: 100%;">
                                <div style="font-size: 5rem; margin-bottom: 20px;">üßÆ</div>
                                <div style="background-color: #333; color: white; padding: 20px; border-radius: 10px; font-family: monospace; font-size: 1.8rem; margin-bottom: 20px;">
                                    (7 √ó 6) + (10 √∑ 2) - 5 = ?
                                </div>
                                <div style="font-weight: bold; color: var(--comic-yellow);">
                                    Solve the equation to find the answer.
                                </div>
                            </div>
                        `,
                        instructions: "Calculate the mathematical expression above. Enter the numerical answer.",
                        hint: "Remember the order of operations: parentheses first, then multiplication/division, then addition/subtraction."
                    }
                },
                {
                    id: 6,
                    title: "The Final Combination",
                    description: "You've reached the final panel! Combine all the clues you've collected to escape.",
                    status: "unsolved",
                    solution: "COMICBOOK",
                    type: "final",
                    content: {
                        visual: `
                            <div style="text-align: center; width: 100%;">
                                <div style="font-size: 5rem; margin-bottom: 20px;">üö™</div>
                                <div style="background-color: #222; color: white; padding: 20px; border-radius: 10px; font-family: monospace; font-size: 1.2rem; margin-bottom: 20px; text-align: left;">
                                    <div>PANEL 1: First letter of solution = C</div>
                                    <div>PANEL 2: The decoded word = COMIC</div>
                                    <div>PANEL 3: Shape = TRIANGLE (not needed)</div>
                                    <div>PANEL 4: Hidden object = KEY (K)</div>
                                    <div>PANEL 5: Mathematical answer = 42 (not needed)</div>
                                    <div>PANEL 6: Combine all relevant letters...</div>
                                </div>
                                <div style="font-weight: bold; color: var(--comic-red);">
                                    Combine the clues to form the final password!
                                </div>
                            </div>
                        `,
                        instructions: "You need to combine clues from previous puzzles. From Panel 1, take the first letter of the solution. From Panel 2, use the whole word. From Panel 4, use the first letter. Combine them to form one word.",
                        hint: "C + COMIC + K = C COMIC K. Now rearrange to form a meaningful word."
                    }
                }
            ];
            
            // Initialize the game
            function init() {
                // Load saved game state
                loadGameState();
                
                // Create panels
                createPanels();
                
                // Set up event listeners
                setupEventListeners();
                
                // Update progress
                updateProgress();
                
                // Play page turn sound
                playSound(pageSound);
            }
            
            // Create comic panels
            function createPanels() {
                panelsContainer.innerHTML = '';
                
                puzzles.forEach(puzzle => {
                    const panel = document.createElement('div');
                    panel.className = `panel ${puzzle.status === 'solved' ? 'solved' : 'unsolved'} ${puzzle.id > 1 && !isPanelUnlocked(puzzle.id) ? 'locked' : ''}`;
                    panel.dataset.id = puzzle.id;
                    
                    // Panel number
                    const panelNumber = document.createElement('div');
                    panelNumber.className = 'panel-number';
                    panelNumber.textContent = puzzle.id;
                    
                    // Panel content
                    const panelContent = document.createElement('div');
                    panelContent.className = 'panel-content';
                    
                    // Panel title
                    const panelTitle = document.createElement('h3');
                    panelTitle.className = 'panel-title';
                    panelTitle.textContent = puzzle.title;
                    
                    // Panel image placeholder
                    const panelImage = document.createElement('div');
                    panelImage.className = 'panel-image';
                    
                    // Different icons for different puzzle types
                    const iconMap = {
                        'riddle': 'üîç',
                        'cipher': 'üìú',
                        'pattern': 'üß©',
                        'hidden': 'üîé',
                        'math': 'üßÆ',
                        'final': 'üö™'
                    };
                    
                    panelImage.innerHTML = `<div style="font-size: 4rem;">${iconMap[puzzle.type]}</div>`;
                    
                    // Panel description
                    const panelDescription = document.createElement('p');
                    panelDescription.className = 'panel-description';
                    panelDescription.textContent = puzzle.description;
                    
                    // Panel status
                    const panelStatus = document.createElement('div');
                    panelStatus.className = `panel-status ${puzzle.status}`;
                    panelStatus.textContent = puzzle.status === 'solved' ? 'SOLVED!' : 'UNSOLVED';
                    
                    // Add inventory if any
                    const inventory = document.createElement('div');
                    inventory.className = 'inventory';
                    
                    // Add items found in this panel to inventory
                    const panelInventory = getPanelInventory(puzzle.id);
                    panelInventory.forEach(item => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'inventory-item';
                        itemElement.innerHTML = `<i class="fas fa-key"></i> ${item}`;
                        inventory.appendChild(itemElement);
                    });
                    
                    // Assemble panel
                    panelContent.appendChild(panelTitle);
                    panelContent.appendChild(panelImage);
                    panelContent.appendChild(panelDescription);
                    
                    if (panelInventory.length > 0) {
                        panelContent.appendChild(inventory);
                    }
                    
                    panelContent.appendChild(panelStatus);
                    
                    panel.appendChild(panelNumber);
                    panel.appendChild(panelContent);
                    
                    // Add click event if not locked
                    if (!panel.classList.contains('locked')) {
                        panel.addEventListener('click', () => openPuzzle(puzzle.id));
                    }
                    
                    panelsContainer.appendChild(panel);
                });
            }
            
            // Check if a panel is unlocked
            function isPanelUnlocked(panelId) {
                // Panel 1 is always unlocked
                if (panelId === 1) return true;
                
                // Other panels require all previous panels to be solved
                for (let i = 1; i < panelId; i++) {
                    const prevPuzzle = puzzles.find(p => p.id === i);
                    if (!prevPuzzle || prevPuzzle.status !== 'solved') {
                        return false;
                    }
                }
                
                return true;
            }
            
            // Get inventory items from a panel
            function getPanelInventory(panelId) {
                const items = [];
                
                if (panelId === 2 && puzzles[1].status === 'solved') {
                    items.push('DECODED MESSAGE');
                }
                
                if (panelId === 4 && puzzles[3].status === 'solved') {
                    items.push('SMALL KEY');
                }
                
                if (panelId === 5 && puzzles[4].status === 'solved') {
                    items.push('NUMBER 42');
                }
                
                return items;
            }
            
            // Open a puzzle
            function openPuzzle(panelId) {
                const puzzle = puzzles.find(p => p.id === panelId);
                if (!puzzle) return;
                
                // Set current panel
                gameState.currentPanel = panelId;
                
                // Update panel display
                puzzleTitle.textContent = `PANEL ${panelId}: ${puzzle.title}`;
                
                // Create puzzle content
                createPuzzleContent(puzzle);
                
                // Show puzzle display
                puzzleDisplay.classList.add('active');
                
                // Highlight active panel
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.querySelector(`.panel[data-id="${panelId}"]`).classList.add('active');
                
                // Play sound
                playSound(pageSound);
            }
            
            // Create puzzle content
            function createPuzzleContent(puzzle) {
                puzzleContent.innerHTML = '';
                
                // Add speech bubble with instructions
                const speechBubble = document.createElement('div');
                speechBubble.className = 'speech-bubble';
                speechBubble.innerHTML = `<p><strong>Comic Hero:</strong> ${puzzle.content.instructions}</p>`;
                puzzleContent.appendChild(speechBubble);
                
                // Add puzzle scene
                const puzzleScene = document.createElement('div');
                puzzleScene.className = 'puzzle-scene';
                
                // Visual element
                const puzzleVisual = document.createElement('div');
                puzzleVisual.className = 'puzzle-visual';
                puzzleVisual.innerHTML = puzzle.content.visual;
                
                // Interaction element
                const puzzleInteraction = document.createElement('div');
                puzzleInteraction.className = 'puzzle-interaction';
                
                // Input for answer
                const answerInput = document.createElement('input');
                answerInput.type = 'text';
                answerInput.className = 'puzzle-input';
                answerInput.placeholder = 'Enter your answer here...';
                answerInput.id = 'answerInput';
                
                // Submit button
                const submitButton = document.createElement('button');
                submitButton.className = 'comic-button primary';
                submitButton.innerHTML = '<i class="fas fa-check-circle"></i> Submit Answer';
                submitButton.addEventListener('click', () => checkAnswer(puzzle.id, answerInput.value));
                
                // Hint button
                const hintButton = document.createElement('button');
                hintButton.className = 'comic-button secondary';
                hintButton.innerHTML = '<i class="fas fa-lightbulb"></i> Get Hint';
                hintButton.addEventListener('click', () => showHint(puzzle.content.hint));
                
                // Button container
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'puzzle-buttons';
                buttonContainer.appendChild(submitButton);
                buttonContainer.appendChild(hintButton);
                
                // Allow Enter key to submit
                answerInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkAnswer(puzzle.id, answerInput.value);
                    }
                });
                
                // Assemble interaction
                puzzleInteraction.appendChild(answerInput);
                puzzleInteraction.appendChild(buttonContainer);
                
                // Assemble scene
                puzzleScene.appendChild(puzzleVisual);
                puzzleScene.appendChild(puzzleInteraction);
                
                // Add to content
                puzzleContent.appendChild(puzzleScene);
                
                // Add hint container (hidden by default)
                const hintContainer = document.createElement('div');
                hintContainer.className = 'hint-container';
                hintContainer.id = 'hintContainer';
                hintContainer.innerHTML = `
                    <div class="hint-title">
                        <i class="fas fa-lightbulb"></i> HINT
                    </div>
                    <p id="hintText"></p>
                `;
                puzzleContent.appendChild(hintContainer);
                
                // Focus on input
                setTimeout(() => answerInput.focus(), 100);
            }
            
            // Show hint
            function showHint(hintText) {
                const hintContainer = document.getElementById('hintContainer');
                const hintTextElement = document.getElementById('hintText');
                
                hintTextElement.textContent = hintText;
                hintContainer.classList.add('active');
                
                // Track hint usage
                gameState.hintsUsed++;
                saveGameState();
            }
            
            // Check answer
            function checkAnswer(panelId, answer) {
                const puzzle = puzzles.find(p => p.id === panelId);
                if (!puzzle) return;
                
                const normalizedAnswer = answer.trim().toUpperCase();
                const normalizedSolution = puzzle.solution.toUpperCase();
                
                let isCorrect = false;
                
                // Handle different puzzle types
                if (puzzle.type === 'math') {
                    // For math puzzles, check numeric equality
                    isCorrect = parseInt(normalizedAnswer) === parseInt(normalizedSolution);
                } else {
                    // For other puzzles, check string equality
                    isCorrect = normalizedAnswer === normalizedSolution;
                }
                
                if (isCorrect) {
                    // Mark puzzle as solved
                    puzzle.status = 'solved';
                    
                    // Add to solved panels if not already there
                    if (!gameState.solvedPanels.includes(panelId)) {
                        gameState.solvedPanels.push(panelId);
                    }
                    
                    // Add inventory items based on puzzle
                    addInventoryItem(panelId);
                    
                    // Update game state
                    saveGameState();
                    
                    // Update UI
                    updateProgress();
                    createPanels();
                    
                    // Show success message
                    showMessage('Correct!', 'success');
                    
                    // Play success sound
                    playSound(correctSound);
                    
                    // Check if all puzzles are solved
                    if (gameState.solvedPanels.length === puzzles.length) {
                        setTimeout(() => {
                            puzzleDisplay.classList.remove('active');
                            showSuccessScreen();
                        }, 1500);
                    } else {
                        // Close puzzle after delay
                        setTimeout(() => {
                            puzzleDisplay.classList.remove('active');
                            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                        }, 1500);
                    }
                } else {
                    // Show error message
                    showMessage('Try again!', 'error');
                    
                    // Shake input
                    const answerInput = document.getElementById('answerInput');
                    answerInput.classList.add('shake');
                    setTimeout(() => answerInput.classList.remove('shake'), 500);
                    
                    // Play error sound
                    playSound(wrongSound);
                }
            }
            
            // Add inventory item based on solved puzzle
            function addInventoryItem(panelId) {
                if (panelId === 2) {
                    gameState.inventory.push('DECODED MESSAGE: COMIC');
                } else if (panelId === 4) {
                    gameState.inventory.push('SMALL KEY');
                } else if (panelId === 5) {
                    gameState.inventory.push('NUMBER 42');
                }
            }
            
            // Show message
            function showMessage(text, type) {
                // Create message element
                const message = document.createElement('div');
                message.className = `speech-bubble ${type === 'success' ? 'right' : ''}`;
                message.style.backgroundColor = type === 'success' ? 'var(--comic-green)' : 'var(--comic-red)';
                message.style.color = 'white';
                message.style.borderColor = type === 'success' ? 'var(--comic-green)' : 'var(--comic-red)';
                message.innerHTML = `<p><strong>${type === 'success' ? 'SUCCESS!' : 'OOPS!'}</strong> ${text}</p>`;
                
                // Add to puzzle content
                puzzleContent.appendChild(message);
                
                // Remove after delay
                setTimeout(() => {
                    if (message.parentNode) {
                        message.remove();
                    }
                }, 3000);
            }
            
            // Update progress
            function updateProgress() {
                const solvedCount = gameState.solvedPanels.length;
                const totalCount = puzzles.length;
                const percentage = (solvedCount / totalCount) * 100;
                
                progressFill.style.width = `${percentage}%`;
                progressText.textContent = `${solvedCount}/${totalCount} Puzzles Solved`;
            }
            
            // Show success screen
            function showSuccessScreen() {
                successScreen.classList.add('active');
                playSound(successSound);
            }
            
            // Play sound
            function playSound(audioElement) {
                if (audioElement) {
                    audioElement.currentTime = 0;
                    audioElement.play().catch(e => console.log("Audio play failed:", e));
                }
            }
            
            // Save game state
            function saveGameState() {
                localStorage.setItem('comicEscapeRoomState', JSON.stringify(gameState));
            }
            
            // Load game state
            function loadGameState() {
                const saved = localStorage.getItem('comicEscapeRoomState');
                if (saved) {
                    try {
                        const savedState = JSON.parse(saved);
                        gameState = savedState;
                        
                        // Update puzzle statuses based on solved panels
                        puzzles.forEach(puzzle => {
                            if (gameState.solvedPanels.includes(puzzle.id)) {
                                puzzle.status = 'solved';
                            } else {
                                puzzle.status = 'unsolved';
                            }
                        });
                    } catch (e) {
                        console.log("Error loading saved game:", e);
                    }
                }
            }
            
            // Reset game
            function resetGame() {
                // Reset game state
                gameState = {
                    currentPanel: null,
                    solvedPanels: [],
                    inventory: [],
                    hintsUsed: 0
                };
                
                // Reset puzzles
                puzzles.forEach(puzzle => {
                    puzzle.status = 'unsolved';
                });
                
                // Save and reload
                saveGameState();
                createPanels();
                updateProgress();
                
                // Hide success screen
                successScreen.classList.remove('active');
                
                // Play page sound
                playSound(pageSound);
            }
            
            // Set up event listeners
            function setupEventListeners() {
                // Close puzzle button
                puzzleClose.addEventListener('click', () => {
                    puzzleDisplay.classList.remove('active');
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                });
                
                // Restart button
                restartButton.addEventListener('click', resetGame);
                
                // Close puzzle when clicking outside (on overlay)
                puzzleDisplay.addEventListener('click', function(e) {
                    if (e.target === puzzleDisplay) {
                        puzzleDisplay.classList.remove('active');
                        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    }
                });
                
                // Add some comic book sound effects
                document.querySelectorAll('.panel').forEach(panel => {
                    panel.addEventListener('mouseenter', () => {
                        if (!panel.classList.contains('locked')) {
                            // Play a subtle sound effect on hover
                            pageSound.currentTime = 0.1;
                            pageSound.play().catch(() => {});
                        }
                    });
                });
            }
            
            // Initialize the game
            init();
        });
    </script>
</body>
</html>