<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Story: The Midnight Library</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Georgia', 'Times New Roman', serif;
        }
        
        body {
            background: linear-gradient(135deg, #0c2461, #1e3799);
            color: #f7f1e3;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            z-index: -1;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            border: 2px solid #f7f1e3;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #ff9f43, #ffaf60);
        }
        
        h1 {
            font-size: 3.2rem;
            margin-bottom: 10px;
            color: #ff9f43;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            font-family: 'Cambria', 'Cochin', serif;
        }
        
        .tagline {
            font-size: 1.3rem;
            color: #f7f1e3;
            margin-bottom: 15px;
            font-style: italic;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #57606f;
            flex-wrap: wrap;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px 20px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ff9f43;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #ced6e0;
        }
        
        .story-container {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid #57606f;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .story-container::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(255, 159, 67, 0.1) 0%, rgba(255, 159, 67, 0) 70%);
            border-radius: 50%;
        }
        
        .story-text {
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 30px;
            text-align: justify;
            color: #f7f1e3;
        }
        
        .choices-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .choice-btn {
            padding: 25px;
            background: rgba(255, 159, 67, 0.1);
            border: 2px solid #ff9f43;
            border-radius: 15px;
            color: #f7f1e3;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover {
            background: rgba(255, 159, 67, 0.3);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(255, 159, 67, 0.3);
        }
        
        .choice-btn:active {
            transform: translateY(0);
        }
        
        .choice-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: 0.5s;
        }
        
        .choice-btn:hover::before {
            left: 100%;
        }
        
        .choice-number {
            display: inline-block;
            width: 35px;
            height: 35px;
            background: #ff9f43;
            color: #0c2461;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            margin-right: 15px;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .restart-btn {
            background: linear-gradient(to right, #ff9f43, #ffaf60);
            color: #0c2461;
        }
        
        .history-btn {
            background: linear-gradient(to right, #3742fa, #5352ed);
            color: white;
        }
        
        .save-btn {
            background: linear-gradient(to right, #2ed573, #1dd1a1);
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .control-btn:active {
            transform: translateY(1px);
        }
        
        .ending-container {
            display: none;
            text-align: center;
            padding: 40px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            margin-top: 30px;
            border: 3px solid;
            animation: fadeIn 1s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .ending-good {
            border-color: #2ed573;
            background: rgba(46, 213, 115, 0.1);
        }
        
        .ending-bad {
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }
        
        .ending-neutral {
            border-color: #747d8c;
            background: rgba(116, 125, 140, 0.1);
        }
        
        .ending-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #ff9f43;
        }
        
        .ending-text {
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 30px;
        }
        
        .ending-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .ending-stat {
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            min-width: 150px;
        }
        
        .ending-stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ff9f43;
        }
        
        .ending-stat-label {
            font-size: 1rem;
            color: #ced6e0;
        }
        
        .endings-gallery {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .ending-card {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .ending-card:hover {
            transform: translateY(-5px);
            border-color: #ff9f43;
        }
        
        .ending-card.unlocked {
            border-color: #2ed573;
        }
        
        .ending-card.locked {
            opacity: 0.6;
            filter: grayscale(0.7);
        }
        
        .ending-card-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #ff9f43;
        }
        
        .ending-card-desc {
            font-size: 0.9rem;
            color: #ced6e0;
            margin-bottom: 15px;
        }
        
        .ending-card-status {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .status-unlocked {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }
        
        .status-locked {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }
        
        .floating-book {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #ff9f43;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0c2461;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 100;
            transition: all 0.3s;
        }
        
        .floating-book:hover {
            transform: scale(1.1);
        }
        
        .history-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            padding: 30px;
            overflow-y: auto;
            transition: right 0.5s;
            z-index: 1000;
            border-left: 2px solid #ff9f43;
        }
        
        .history-panel.active {
            right: 0;
        }
        
        .history-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #ff9f43;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-history {
            background: none;
            border: none;
            color: #ff9f43;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #57606f;
            margin-bottom: 10px;
        }
        
        .history-choice {
            color: #ff9f43;
            font-weight: bold;
        }
        
        .history-text {
            color: #ced6e0;
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        .save-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: rgba(46, 213, 115, 0.9);
            color: white;
            border-radius: 50px;
            font-weight: bold;
            z-index: 1000;
            animation: fadeInOut 2s forwards;
            display: none;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; bottom: 0; }
            20% { opacity: 1; bottom: 20px; }
            80% { opacity: 1; bottom: 20px; }
            100% { opacity: 0; bottom: 0; }
        }
        
        .character-trait {
            display: inline-block;
            padding: 5px 10px;
            background: rgba(255, 159, 67, 0.2);
            border-radius: 20px;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .character-traits {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .story-text {
                font-size: 1.1rem;
            }
            
            .choices-container {
                grid-template-columns: 1fr;
            }
            
            .history-panel {
                width: 100%;
                right: -100%;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-book-open"></i> The Midnight Library</h1>
            <p class="tagline">Your choices shape the story. Discover multiple endings in this interactive narrative.</p>
        </header>
        
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="endingCount">0/12</div>
                <div class="stat-label">Endings Discovered</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="choiceCount">0</div>
                <div class="stat-label">Choices Made</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="characterName">Alex</div>
                <div class="stat-label">Character</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="storyProgress">Chapter 1</div>
                <div class="stat-label">Progress</div>
            </div>
        </div>
        
        <div class="story-container">
            <div class="story-text" id="storyText">
                <!-- Story text will be loaded here -->
            </div>
            
            <div class="choices-container" id="choicesContainer">
                <!-- Choice buttons will be loaded here -->
            </div>
        </div>
        
        <div class="ending-container" id="endingContainer">
            <!-- Ending content will be loaded here -->
        </div>
        
        <div class="endings-gallery" id="endingsGallery">
            <!-- Endings gallery will be loaded here -->
        </div>
        
        <div class="controls">
            <button class="control-btn restart-btn" id="restartBtn">
                <i class="fas fa-redo"></i> Restart Story
            </button>
            <button class="control-btn history-btn" id="historyBtn">
                <i class="fas fa-history"></i> Choice History
            </button>
            <button class="control-btn save-btn" id="saveBtn">
                <i class="fas fa-save"></i> Save Progress
            </button>
        </div>
    </div>
    
    <div class="floating-book" id="endingsBookBtn">
        <i class="fas fa-trophy"></i>
    </div>
    
    <div class="history-panel" id="historyPanel">
        <div class="history-title">
            <span>Your Choice History</span>
            <button class="close-history" id="closeHistoryBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="historyList">
            <!-- History items will be added here -->
        </div>
    </div>
    
    <div class="save-notification" id="saveNotification">
        <i class="fas fa-check-circle"></i> Progress saved successfully!
    </div>

    <script>
        // DOM Elements
        const storyText = document.getElementById('storyText');
        const choicesContainer = document.getElementById('choicesContainer');
        const endingContainer = document.getElementById('endingContainer');
        const endingsGallery = document.getElementById('endingsGallery');
        const restartBtn = document.getElementById('restartBtn');
        const historyBtn = document.getElementById('historyBtn');
        const saveBtn = document.getElementById('saveBtn');
        const endingsBookBtn = document.getElementById('endingsBookBtn');
        const historyPanel = document.getElementById('historyPanel');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const historyList = document.getElementById('historyList');
        const saveNotification = document.getElementById('saveNotification');
        
        // Stats elements
        const endingCountElement = document.getElementById('endingCount');
        const choiceCountElement = document.getElementById('choiceCount');
        const characterNameElement = document.getElementById('characterName');
        const storyProgressElement = document.getElementById('storyProgress');
        
        // Game variables
        let currentChapter = 0;
        let choiceHistory = [];
        let endingsDiscovered = [];
        let choicesMade = 0;
        let characterName = "Alex";
        let characterTraits = {
            courage: 0,
            wisdom: 0,
            curiosity: 0,
            compassion: 0
        };
        
        // Story data - branching narrative
        const story = {
            chapters: [
                {
                    id: 0,
                    title: "Chapter 1: The Mysterious Invitation",
                    text: `You find a peculiar envelope on your doorstep. The paper feels ancient, and the wax seal bears a symbol you don't recognize. Inside, an invitation reads: "You are cordially invited to the Midnight Library. The doors open when the clock strikes twelve. Bring only your curiosity." The date is tonight.`,
                    choices: [
                        {
                            text: "Ignore it. It's probably a prank.",
                            nextChapter: 1,
                            traits: { wisdom: 1 }
                        },
                        {
                            text: "Research the symbol online to learn more.",
                            nextChapter: 2,
                            traits: { curiosity: 2 }
                        },
                        {
                            text: "Prepare to visit the library tonight.",
                            nextChapter: 3,
                            traits: { courage: 2, curiosity: 1 }
                        }
                    ]
                },
                {
                    id: 1,
                    title: "Chapter 2: A Normal Night",
                    text: `You dismiss the invitation as a prank and spend the evening watching TV. Around midnight, you notice something strange - your books seem to be rearranging themselves on the shelf. The invitation on your table glows faintly.`,
                    choices: [
                        {
                            text: "Investigate the glowing invitation.",
                            nextChapter: 3,
                            traits: { curiosity: 2 }
                        },
                        {
                            text: "Go to bed and ignore it all.",
                            nextChapter: 4,
                            traits: { wisdom: 1 }
                        }
                    ]
                },
                {
                    id: 2,
                    title: "Chapter 2: Research Reveals Secrets",
                    text: `Your research leads you to obscure forums mentioning the "Midnight Library" - a place between worlds where stories come alive. Some say it's a trap for the curious, others claim it holds answers to life's greatest mysteries. The clock ticks toward midnight.`,
                    choices: [
                        {
                            text: "This sounds dangerous. Better stay home.",
                            nextChapter: 5,
                            traits: { wisdom: 2 }
                        },
                        {
                            text: "The risk is worth it. I must see this library.",
                            nextChapter: 3,
                            traits: { courage: 3, curiosity: 2 }
                        }
                    ]
                },
                {
                    id: 3,
                    title: "Chapter 3: The Midnight Library",
                    text: `At the stroke of midnight, your room transforms. Bookshelves stretch into infinity, and the air smells of old paper and magic. A librarian with silver eyes approaches. "Welcome, seeker. The library offers knowledge, but every book comes with a price. What do you seek?"`,
                    choices: [
                        {
                            text: "I want to know my future.",
                            nextChapter: 6,
                            traits: { curiosity: 2 }
                        },
                        {
                            text: "Show me how to fix my biggest regret.",
                            nextChapter: 7,
                            traits: { wisdom: 2, compassion: 1 }
                        },
                        {
                            text: "I want power and influence.",
                            nextChapter: 8,
                            traits: { courage: 2 }
                        },
                        {
                            text: "I seek to understand the library itself.",
                            nextChapter: 9,
                            traits: { curiosity: 3, wisdom: 1 }
                        }
                    ]
                },
                {
                    id: 4,
                    title: "Ending: The Sleeper",
                    ending: true,
                    type: "neutral",
                    title: "The Sleeper",
                    text: `You choose the safety of ignorance. The Midnight Library fades from your memory like a half-remembered dream. Life continues normally, but sometimes you wonder about the path not taken when you see books rearrange themselves from the corner of your eye.`,
                    stats: "You avoided danger but also missed extraordinary experiences.",
                    requirements: {}
                },
                {
                    id: 5,
                    title: "Ending: The Cautious Scholar",
                    ending: true,
                    type: "neutral",
                    title: "The Cautious Scholar",
                    text: `Wisdom guided you away from unknown dangers. You continue your research from a distance, learning about the Midnight Library through secondhand accounts. While you never experience its wonders firsthand, your scholarly work becomes the definitive guide to interdimensional libraries.`,
                    stats: "Your wisdom protected you, but curiosity remains unsatisfied.",
                    requirements: { wisdom: 2 }
                },
                {
                    id: 6,
                    title: "Chapter 4: The Book of Futures",
                    text: `The librarian leads you to a massive tome titled "Potential Futures." "This book shows possible paths, not certainties," she warns. As you open it, visions flood your mind: some joyful, some tragic. The book demands a memory in exchange for clarity about one specific future.`,
                    choices: [
                        {
                            text: "Give up a happy memory to see a joyful future.",
                            nextChapter: 10,
                            traits: { courage: 2 }
                        },
                        {
                            text: "Give up a painful memory to avoid a tragic future.",
                            nextChapter: 11,
                            traits: { wisdom: 2 }
                        },
                        {
                            text: "Close the book. I don't want to pay that price.",
                            nextChapter: 12,
                            traits: { wisdom: 3, courage: 1 }
                        }
                    ]
                },
                {
                    id: 7,
                    title: "Chapter 4: The Atlas of Second Chances",
                    text: `The librarian brings you "The Atlas of Second Chances," a book with maps that shift as you watch. "This shows paths to amend regrets," she says. "But changing the past creates ripples. Are you prepared for unintended consequences?"`,
                    choices: [
                        {
                            text: "I'll take the risk. I need to fix this.",
                            nextChapter: 13,
                            traits: { courage: 3, compassion: 2 }
                        },
                        {
                            text: "Show me what would happen if I changed it.",
                            nextChapter: 14,
                            traits: { wisdom: 3, curiosity: 1 }
                        },
                        {
                            text: "Some things are meant to stay in the past.",
                            nextChapter: 15,
                            traits: { wisdom: 2, compassion: 1 }
                        }
                    ]
                },
                {
                    id: 8,
                    title: "Chapter 4: The Tome of Power",
                    text: `"Ambition has its place," the librarian says, handing you a heavy book bound in dark leather. "This contains secrets of influence. But power changes those who wield it. Will you control it, or will it control you?"`,
                    choices: [
                        {
                            text: "I'll use power to help others.",
                            nextChapter: 16,
                            traits: { compassion: 3 }
                        },
                        {
                            text: "I want power for myself.",
                            nextChapter: 17,
                            traits: { courage: 2 }
                        },
                        {
                            text: "This feels dangerous. I should put it back.",
                            nextChapter: 18,
                            traits: { wisdom: 3 }
                        }
                    ]
                },
                {
                    id: 9,
                    title: "Chapter 4: The Librarian's Secret",
                    text: `"Curious about the library itself?" The librarian smiles. "Few ask that question. I am the Guardian, bound to this place between worlds. The library exists where stories intersect with reality. Would you like to understand its mysteries?"`,
                    choices: [
                        {
                            text: "Yes, teach me everything.",
                            nextChapter: 19,
                            traits: { curiosity: 3, wisdom: 2 }
                        },
                        {
                            text: "Just show me how to leave safely.",
                            nextChapter: 20,
                            traits: { wisdom: 2 }
                        }
                    ]
                },
                {
                    id: 10,
                    title: "Ending: The Optimist's Future",
                    ending: true,
                    type: "good",
                    title: "The Optimist's Future",
                    text: `You trade a happy memory for a vision of a joyful future. Inspired by what you saw, you work tirelessly to make that future real. While you can't recall the specific memory you lost, a feeling of warmth guides your choices. Years later, you achieve that beautiful future, though part of your past remains forever in the library.`,
                    stats: "Your courage and optimism shaped a better tomorrow.",
                    requirements: { courage: 2 }
                },
                {
                    id: 11,
                    title: "Ending: The Cautious Path",
                    ending: true,
                    type: "neutral",
                    title: "The Cautious Path",
                    text: `By surrendering a painful memory, you avoid a potential tragedy. The weight of that memory lifts, and your path becomes smoother. However, you sometimes wonder if avoiding that pain also cost you important lessons. Your life is comfortable but perhaps less profound than it could have been.`,
                    stats: "Wisdom protected you from pain but also from growth.",
                    requirements: { wisdom: 2 }
                },
                {
                    id: 12,
                    title: "Ending: The Self-Determined",
                    ending: true,
                    type: "good",
                    title: "The Self-Determined",
                    text: `You refuse to trade memories for glimpses of the future. "My future is mine to make," you tell the librarian. She smiles approvingly. "That is the truest wisdom." You leave the library unchanged but empowered, ready to face life on your own terms without foreknowledge.`,
                    stats: "True wisdom is shaping your own destiny.",
                    requirements: { wisdom: 3, courage: 1 }
                },
                {
                    id: 13,
                    title: "Ending: The Time Weaver",
                    ending: true,
                    type: "mixed",
                    title: "The Time Weaver",
                    text: `You change a crucial moment in your past. The immediate result is exactly what you hoped for. But as years pass, unintended consequences emerge. Some relationships strengthen, others fade. You learn that every choice creates ripples, both good and bad. You become more thoughtful about decisions, understanding their far-reaching impacts.`,
                    stats: "Your compassion changed history, with complex results.",
                    requirements: { courage: 3, compassion: 2 }
                },
                {
                    id: 14,
                    title: "Ending: The Wise Observer",
                    ending: true,
                    type: "good",
                    title: "The Wise Observer",
                    text: `The book shows you the consequences of changing your regret. You see that while fixing it would help in some ways, it would create new problems elsewhere. With this wisdom, you make peace with your past. You leave the library with closure, not by changing history, but by understanding it.`,
                    stats: "True wisdom comes from understanding, not altering, the past.",
                    requirements: { wisdom: 3, curiosity: 1 }
                },
                {
                    id: 15,
                    title: "Ending: The Philosopher",
                    ending: true,
                    type: "neutral",
                    title: "The Philosopher",
                    text: `You decide that regrets are part of what makes you human. "I'll learn from my past rather than erase it," you declare. The librarian nods respectfully. You leave with a philosophical acceptance of life's imperfections, finding beauty in the flawed tapestry of your experiences.`,
                    stats: "Wisdom and compassion brought peace with your past.",
                    requirements: { wisdom: 2, compassion: 1 }
                },
                {
                    id: 16,
                    title: "Ending: The Benevolent Leader",
                    ending: true,
                    type: "good",
                    title: "The Benevolent Leader",
                    text: `You use the library's secrets to gain influence, then employ that power to help others. Communities flourish under your guidance. While power tempts you at times, your compassion keeps you grounded. You become a legendary figure who used extraordinary means for ordinary kindness.`,
                    stats: "Compassion tempered power for the greater good.",
                    requirements: { compassion: 3 }
                },
                {
                    id: 17,
                    title: "Ending: The Power Corrupted",
                    ending: true,
                    type: "bad",
                    title: "The Power Corrupted",
                    text: `Power becomes an addiction. You achieve everything you ever wanted but lose yourself in the process. Friends drift away, replaced by sycophants. One night, you realize you don't recognize the person in the mirror. The library's power gave you the world but took your soul.`,
                    stats: "Power without compassion leads to emptiness.",
                    requirements: { courage: 2 }
                },
                {
                    id: 18,
                    title: "Ending: The Humble Seeker",
                    ending: true,
                    type: "good",
                    title: "The Humble Seeker",
                    text: `Recognizing the danger, you return the book. "Some knowledge isn't meant for mortals," you say. The librarian smiles. "That humility is rarer than courage." You leave without power but with wisdom that guides you to a content, meaningful life helping others in ordinary but important ways.`,
                    stats: "Wisdom recognized that some paths should not be taken.",
                    requirements: { wisdom: 3 }
                },
                {
                    id: 19,
                    title: "Ending: The Librarian's Apprentice",
                    ending: true,
                    type: "good",
                    title: "The Librarian's Apprentice",
                    text: `The Guardian teaches you the library's secrets. You learn to navigate between stories and reality. Eventually, you become an apprentice librarian, helping others find the knowledge they seek. You gain immortality of a sort, living between moments, a guardian of stories and possibilities.`,
                    stats: "Curiosity and wisdom led to becoming part of the story.",
                    requirements: { curiosity: 3, wisdom: 2 }
                },
                {
                    id: 20,
                    title: "Ending: The Safe Return",
                    ending: true,
                    type: "neutral",
                    title: "The Safe Return",
                    text: `The librarian shows you the exit. "You came seeking understanding and left with wisdom," she says. You return to your normal life, but with a new perspective. Books hold deeper meaning now, and you appreciate the mysteries of existence without needing to possess them.`,
                    stats: "Wisdom guided you safely through extraordinary experiences.",
                    requirements: { wisdom: 2 }
                }
            ],
            endings: [
                { id: 4, title: "The Sleeper", type: "neutral", description: "The path of ignorance and safety." },
                { id: 5, title: "The Cautious Scholar", type: "neutral", description: "Wisdom without risk, knowledge without experience." },
                { id: 10, title: "The Optimist's Future", type: "good", description: "Trading memories for hope and inspiration." },
                { id: 11, title: "The Cautious Path", type: "neutral", description: "Avoiding pain at the cost of growth." },
                { id: 12, title: "The Self-Determined", type: "good", description: "Rejecting foresight to shape your own destiny." },
                { id: 13, title: "The Time Weaver", type: "mixed", description: "Changing the past with complex consequences." },
                { id: 14, title: "The Wise Observer", type: "good", description: "Understanding the past to find peace." },
                { id: 15, title: "The Philosopher", type: "neutral", description: "Accepting regrets as part of being human." },
                { id: 16, title: "The Benevolent Leader", type: "good", description: "Using power compassionately for the greater good." },
                { id: 17, title: "The Power Corrupted", type: "bad", description: "Power that consumes the soul." },
                { id: 18, title: "The Humble Seeker", type: "good", description: "Rejecting dangerous knowledge for humility." },
                { id: 19, title: "The Librarian's Apprentice", type: "good", description: "Becoming a guardian of stories and possibilities." },
                { id: 20, title: "The Safe Return", type: "neutral", description: "Returning with wisdom but unchanged." }
            ]
        };
        
        // Initialize the game
        function initGame() {
            currentChapter = 0;
            choicesMade = 0;
            choiceHistory = [];
            characterTraits = {
                courage: 0,
                wisdom: 0,
                curiosity: 0,
                compassion: 0
            };
            
            // Try to load saved progress
            loadProgress();
            
            // Update UI
            updateStats();
            updateEndingsGallery();
            loadChapter();
            
            // Hide ending container
            endingContainer.style.display = 'none';
            endingsGallery.style.display = 'none';
            
            // Clear history list
            historyList.innerHTML = '<div class="history-item"><div class="history-text">Story began...</div></div>';
        }
        
        // Load a chapter
        function loadChapter() {
            const chapter = story.chapters[currentChapter];
            
            // Update story text
            storyText.innerHTML = `
                <h3 style="color: #ff9f43; margin-bottom: 15px;">${chapter.title}</h3>
                <p>${chapter.text}</p>
                <div class="character-traits" id="characterTraitsDisplay">
                    ${getCharacterTraitsHTML()}
                </div>
            `;
            
            // Update progress
            storyProgressElement.textContent = chapter.title.split(":")[0];
            
            // Clear choices container
            choicesContainer.innerHTML = '';
            
            // Check if this is an ending
            if (chapter.ending) {
                showEnding(chapter);
                return;
            }
            
            // Create choice buttons
            chapter.choices.forEach((choice, index) => {
                const choiceBtn = document.createElement('button');
                choiceBtn.className = 'choice-btn';
                choiceBtn.innerHTML = `
                    <span class="choice-number">${index + 1}</span>
                    ${choice.text}
                `;
                
                choiceBtn.addEventListener('click', () => makeChoice(choice, index));
                choicesContainer.appendChild(choiceBtn);
            });
        }
        
        // Make a choice
        function makeChoice(choice, choiceIndex) {
            // Record choice in history
            const chapter = story.chapters[currentChapter];
            choiceHistory.push({
                chapter: chapter.title,
                choice: choice.text,
                timestamp: new Date().toLocaleTimeString()
            });
            
            // Update history display
            addToHistory(chapter.title, choice.text);
            
            // Update traits
            if (choice.traits) {
                Object.keys(choice.traits).forEach(trait => {
                    characterTraits[trait] += choice.traits[trait];
                });
            }
            
            // Update stats
            choicesMade++;
            
            // Move to next chapter
            currentChapter = choice.nextChapter;
            
            // Update UI
            updateStats();
            loadChapter();
        }
        
        // Show ending
        function showEnding(chapter) {
            // Hide choices
            choicesContainer.innerHTML = '';
            
            // Check if this ending is new
            let isNewEnding = false;
            if (!endingsDiscovered.includes(chapter.id)) {
                endingsDiscovered.push(chapter.id);
                isNewEnding = true;
            }
            
            // Update endings count
            updateStats();
            
            // Show ending container
            endingContainer.className = `ending-container ending-${chapter.type}`;
            endingContainer.style.display = 'block';
            
            // Create ending content
            endingContainer.innerHTML = `
                <div class="ending-title">
                    <i class="fas fa-${chapter.type === 'good' ? 'crown' : chapter.type === 'bad' ? 'skull' : 'balance-scale'}"></i>
                    ${chapter.title}
                    ${isNewEnding ? '<span style="font-size: 1rem; color: #2ed573; margin-left: 10px;">(NEW!)</span>' : ''}
                </div>
                <div class="ending-text">${chapter.text}</div>
                <div class="ending-stats">
                    <div class="ending-stat">
                        <div class="ending-stat-value">${getEndingTypeIcon(chapter.type)}</div>
                        <div class="ending-stat-label">Ending Type</div>
                    </div>
                    <div class="ending-stat">
                        <div class="ending-stat-value">${choicesMade}</div>
                        <div class="ending-stat-label">Choices Made</div>
                    </div>
                    <div class="ending-stat">
                        <div class="ending-stat-value">${endingsDiscovered.length}</div>
                        <div class="ending-stat-label">Endings Found</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                    <strong>Character Summary:</strong> ${chapter.stats}
                </div>
                <div class="character-traits" style="margin-top: 20px;">
                    ${getCharacterTraitsHTML()}
                </div>
                <button class="control-btn restart-btn" style="margin-top: 30px;" onclick="initGame()">
                    <i class="fas fa-redo"></i> Start New Story
                </button>
            `;
            
            // Update endings gallery
            updateEndingsGallery();
            
            // Save progress
            saveProgress();
        }
        
        // Add choice to history panel
        function addToHistory(chapterTitle, choiceText) {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <div class="history-choice">${choiceText}</div>
                <div class="history-text">From: ${chapterTitle}</div>
                <div class="history-text" style="font-size: 0.8rem;">${new Date().toLocaleTimeString()}</div>
            `;
            
            // Add to top of history list
            historyList.insertBefore(historyItem, historyList.firstChild);
        }
        
        // Update stats display
        function updateStats() {
            endingCountElement.textContent = `${endingsDiscovered.length}/${story.endings.length}`;
            choiceCountElement.textContent = choicesMade;
            characterNameElement.textContent = characterName;
        }
        
        // Get character traits as HTML
        function getCharacterTraitsHTML() {
            let html = '<strong>Your Traits:</strong><br>';
            Object.keys(characterTraits).forEach(trait => {
                const value = characterTraits[trait];
                if (value > 0) {
                    html += `<span class="character-trait">${trait.charAt(0).toUpperCase() + trait.slice(1)}: ${value}</span>`;
                }
            });
            return html;
        }
        
        // Get icon for ending type
        function getEndingTypeIcon(type) {
            switch(type) {
                case 'good': return '<i class="fas fa-crown"></i>';
                case 'bad': return '<i class="fas fa-skull"></i>';
                case 'mixed': return '<i class="fas fa-balance-scale"></i>';
                default: return '<i class="fas fa-circle"></i>';
            }
        }
        
        // Update endings gallery
        function updateEndingsGallery() {
            endingsGallery.innerHTML = '';
            
            story.endings.forEach(ending => {
                const endingCard = document.createElement('div');
                endingCard.className = `ending-card ${endingsDiscovered.includes(ending.id) ? 'unlocked' : 'locked'}`;
                
                const isUnlocked = endingsDiscovered.includes(ending.id);
                
                endingCard.innerHTML = `
                    <div class="ending-card-title">${ending.title}</div>
                    <div class="ending-card-desc">${ending.description}</div>
                    <div class="ending-card-status ${isUnlocked ? 'status-unlocked' : 'status-locked'}">
                        ${isUnlocked ? '<i class="fas fa-unlock"></i> Unlocked' : '<i class="fas fa-lock"></i> Locked'}
                    </div>
                `;
                
                if (isUnlocked) {
                    endingCard.addEventListener('click', () => {
                        // Show ending details
                        const chapter = story.chapters.find(c => c.id === ending.id);
                        if (chapter) {
                            showEnding(chapter);
                            // Scroll to ending container
                            endingContainer.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                }
                
                endingsGallery.appendChild(endingCard);
            });
        }
        
        // Save progress to localStorage
        function saveProgress() {
            const progress = {
                endingsDiscovered: endingsDiscovered,
                choicesMade: choicesMade,
                characterName: characterName,
                characterTraits: characterTraits,
                choiceHistory: choiceHistory.slice(-20) // Keep last 20 choices
            };
            
            localStorage.setItem('midnightLibraryProgress', JSON.stringify(progress));
            
            // Show save notification
            saveNotification.style.display = 'block';
            setTimeout(() => {
                saveNotification.style.display = 'none';
            }, 2000);
        }
        
        // Load progress from localStorage
        function loadProgress() {
            const saved = localStorage.getItem('midnightLibraryProgress');
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    endingsDiscovered = progress.endingsDiscovered || [];
                    choicesMade = progress.choicesMade || 0;
                    characterName = progress.characterName || "Alex";
                    characterTraits = progress.characterTraits || {
                        courage: 0,
                        wisdom: 0,
                        curiosity: 0,
                        compassion: 0
                    };
                    choiceHistory = progress.choiceHistory || [];
                    
                    // Restore history display
                    historyList.innerHTML = '';
                    choiceHistory.forEach(item => {
                        addToHistory(item.chapter, item.choice);
                    });
                    
                } catch (e) {
                    console.error("Failed to load progress:", e);
                }
            }
        }
        
        // Show endings gallery
        function showEndingsGallery() {
            endingsGallery.style.display = 'grid';
            endingsGallery.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Toggle history panel
        function toggleHistoryPanel() {
            historyPanel.classList.toggle('active');
        }
        
        // Event Listeners
        restartBtn.addEventListener('click', initGame);
        historyBtn.addEventListener('click', toggleHistoryPanel);
        closeHistoryBtn.addEventListener('click', toggleHistoryPanel);
        saveBtn.addEventListener('click', saveProgress);
        endingsBookBtn.addEventListener('click', showEndingsGallery);
        
        // Allow changing character name
        characterNameElement.addEventListener('click', () => {
            const newName = prompt("Enter your character's name:", characterName);
            if (newName && newName.trim() !== "") {
                characterName = newName.trim();
                characterNameElement.textContent = characterName;
                saveProgress();
            }
        });
        
        // Initialize the game
        initGame();
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Number keys 1-3 for selecting choices
            if (e.key >= '1' && e.key <= '3') {
                const index = parseInt(e.key) - 1;
                const choiceButtons = document.querySelectorAll('.choice-btn');
                if (index < choiceButtons.length) {
                    choiceButtons[index].click();
                }
            }
            
            // H for history
            if (e.key === 'h' || e.key === 'H') {
                toggleHistoryPanel();
            }
            
            // R for restart
            if (e.key === 'r' || e.key === 'R') {
                if (confirm("Restart the story? Your progress will be saved.")) {
                    initGame();
                }
            }
            
            // E for endings gallery
            if (e.key === 'e' || e.key === 'E') {
                showEndingsGallery();
            }
            
            // S for save
            if (e.key === 's' || e.key === 'S' && e.ctrlKey) {
                e.preventDefault();
                saveProgress();
            }
        });
        
        // Add instructions for keyboard shortcuts
        document.addEventListener('DOMContentLoaded', () => {
            const tagline = document.querySelector('.tagline');
            tagline.innerHTML += '<br><small>Press 1-3 to choose, H for history, R to restart, E for endings, Ctrl+S to save</small>';
        });
    </script>
</body>
</html>